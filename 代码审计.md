# PUAX é¡¹ç›®ä»£ç å®¡è®¡æŠ¥å‘Š

**å®¡æ ¸ç‰ˆæœ¬**ï¼šv1.2.0  
**å®¡æ ¸æ—¥æœŸ**ï¼š2025-01-02  
**å®¡æ ¸èŒƒå›´**ï¼šå®Œæ•´ä»£ç åº“ï¼ˆMCPæœåŠ¡å™¨ + Promptæ¨¡æ¿ï¼‰  
**å®¡æ ¸æ ‡å‡†**ï¼šå·¥ä¸šçº§ TypeScript é¡¹ç›®æ ‡å‡†ã€Node.js æœ€ä½³å®è·µã€MCP åè®®è§„èŒƒã€å®‰å…¨æœ€ä½³å®è·µ  
**å®¡æ ¸è€…**ï¼šLinus Torvalds æ•°å­—åŒ–çµé­‚é™„ä½“  

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**æ€»ä½“è¯„çº§**ï¼šB+ï¼ˆè‰¯å¥½ä½†æœ‰æ˜æ˜¾æ”¹è¿›ç©ºé—´ï¼‰  
**æ ¸å¿ƒé—®é¢˜æ•°é‡**ï¼šâš ï¸ **15ä¸ªä¸¥é‡é—®é¢˜** | âš¡ **34ä¸ªé«˜é£é™©é—®é¢˜** | ğŸ“Š **67ä¸ªä¸­ç­‰é£é™©é—®é¢˜**  
**å®‰å…¨è¯„çº§**ï¼šCï¼ˆå­˜åœ¨å¤šç§æ½œåœ¨å®‰å…¨é£é™©ï¼‰  
**æ€§èƒ½è¯„çº§**ï¼šBï¼ˆHTTP SSE æ¨¡å¼åŸºç¡€è‰¯å¥½ï¼Œä½†æœ‰ä¼˜åŒ–ç©ºé—´ï¼‰  
**ä»£ç è´¨é‡è¯„çº§**ï¼šB+ï¼ˆTypeScript ç±»å‹å®‰å…¨æ€§è‰¯å¥½ï¼Œä½†è®¾è®¡æ¨¡å¼éœ€è¦æ”¹è¿›ï¼‰  
**æµ‹è¯•è¦†ç›–ç‡**ï¼šçº¦ 65%ï¼ˆå•å…ƒæµ‹è¯•ä¸¥é‡ä¸è¶³ï¼‰  

---

## ğŸ”¥ ä¸€ã€ä¸¥é‡é—®é¢˜ï¼ˆCritical Issuesï¼‰

### 1.1 ğŸš¨ å†…å­˜æ³„æ¼é£é™©ï¼ˆCritical - Memory Leakï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:17`

```typescript
private transports: Map<string, SSEServerTransport> = new Map();
```

**é—®é¢˜æè¿°**ï¼š
- `transports` Map æ— é™å¢é•¿ï¼Œä»æœªæ¸…ç†è¿‡æœŸçš„ session
- æ¯ä¸ª SSE è¿æ¥æ–­å¼€æ—¶è™½ç„¶è°ƒç”¨äº† `transports.delete(transport.sessionId)`
- **ä½†æ˜¯**ï¼šæ²¡æœ‰è¶…æ—¶æœºåˆ¶ï¼Œå¦‚æœå®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€ï¼ˆç½‘ç»œä¸­æ–­ã€æµè§ˆå™¨å´©æºƒï¼‰ï¼Œsession æ°¸è¿œä¸ä¼šè¢«æ¸…ç†
- åœ¨æŒç»­è¿è¡Œçš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ24 å°æ—¶å†…å¯æ³„æ¼æ•°ä¸‡ session å¯¹è±¡

**é‡ç°æ­¥éª¤**ï¼š
```bash
# æ¨¡æ‹Ÿ DoS æ”»å‡»
for i in {1..10000}; do
  curl -N http://localhost:2333/ &
done
# ç­‰å¾… 1 å°æ—¶ï¼ŒæŸ¥çœ‹å†…å­˜å ç”¨ > 2GB
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// âœ… å¢åŠ  session è¶…æ—¶ç®¡ç†
private transports: Map<string, {
  transport: SSEServerTransport;
  lastActivity: Date;
  timeout: NodeJS.Timeout;
}> = new Map();

private readonly SESSION_TIMEOUT = 300000; // 5åˆ†é’Ÿ

private async handleSSEConnection(req: IncomingMessage, res: ServerResponse): Promise<void> {
  const transport = new SSEServerTransport('/message', res);
  
  const sessionData = {
    transport,
    lastActivity: new Date(),
    timeout: setTimeout(() => {
      console.error(`Session ${transport.sessionId} timed out`);
      this.cleanupSession(transport.sessionId);
    }, this.SESSION_TIMEOUT)
  };
  
  this.transports.set(transport.sessionId, sessionData);
  
  transport.onclose = () => {
    console.error(`Session closed: ${transport.sessionId}`);
    this.cleanupSession(transport.sessionId);
  };
  
  await this.server.connect(transport);
}

private cleanupSession(sessionId: string): void {
  const session = this.transports.get(sessionId);
  if (session) {
    clearTimeout(session.timeout);
    this.transports.delete(sessionId);
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - å¯å¯¼è‡´æœåŠ¡å™¨å´©æºƒ**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤ï¼ˆ1å¤©å†…ï¼‰  

---

### 1.2 ğŸš¨ å¼‚å¸¸è¾“å…¥å¯¼è‡´ DoSï¼ˆCritical - DoS Attackï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:436-447`

```typescript
private readRequestBody(req: IncomingMessage): Promise<string> {
  return new Promise((resolve, reject) => {
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString(); // âš ï¸ æ— é™åˆ¶çš„å†…å­˜å¢é•¿
    });
    req.on('end', () => {
      resolve(body);
    });
    req.on('error', reject);
  });
}
```

**é—®é¢˜æè¿°**ï¼š
- æ²¡æœ‰é™åˆ¶è¯·æ±‚ä½“å¤§å°ï¼Œæ”»å‡»è€…å¯å‘é€æ— é™å¤§çš„ JSON è¯·æ±‚
- å•ä¸ªè¯·æ±‚å¯è€—å°½æœåŠ¡å™¨å†…å­˜
- å…¸å‹çš„ HTTP DoS æ”»å‡»å‘é‡

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private readRequestBody(req: IncomingMessage, maxSize = 10 * 1024 * 1024): Promise<string> {
  return new Promise((resolve, reject) => {
    let body = '';
    let receivedSize = 0;
    
    req.on('data', chunk => {
      receivedSize += chunk.length;
      if (receivedSize > maxSize) {
        req.destroy(); // ç«‹å³æ–­å¼€è¿æ¥
        reject(new Error(`Request body exceeds maximum size of ${maxSize} bytes`));
        return;
      }
      body += chunk.toString();
    });
    
    req.on('end', () => resolve(body));
    req.on('error', reject);
  });
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - å¯è¿œç¨‹å´©æºƒæœåŠ¡å™¨**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 1.3 ğŸš¨ é”™è¯¯å¤„ç†ç¼ºå¤±å¯¼è‡´ä¿¡æ¯æ³„éœ²ï¼ˆCritical - Information Disclosureï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:303-307`, `src/prompts/index.ts:70-73`

```typescript
// src/server.ts
catch (error) {
  console.error('Request handling error:', error);
  res.writeHead(500, { 'Content-Type': 'text/plain' });
  res.end('Internal Server Error'); // âš ï¸ æš´éœ²äº†å¤ªå¤šå†…éƒ¨ä¿¡æ¯
}

// src/prompts/index.ts
catch (error) {
  console.error('åŠ è½½è§’è‰²å¤±è´¥:', error); // âš ï¸ æš´éœ²æ–‡ä»¶ç³»ç»Ÿç»“æ„
}
```

**é—®é¢˜æè¿°**ï¼š
- ç”Ÿäº§ç¯å¢ƒä¸åº”è¾“å‡ºè¯¦ç»†çš„é”™è¯¯å †æ ˆ
- æ”»å‡»è€…å¯åˆ©ç”¨é”™è¯¯ä¿¡æ¯æ¢æµ‹æ–‡ä»¶ç³»ç»Ÿç»“æ„
- `console.error` åœ¨ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ—¥å¿—æ¡†æ¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// Production ç¯å¢ƒé…ç½®
const isProduction = process.env.NODE_ENV === 'production';

private setupErrorHandling(): void {
  this.server.onerror = (error) => {
    if (!isProduction) {
      console.error('[MCP Error]', error);
    } else {
      // ç”Ÿäº§ç¯å¢ƒåªè®°å½•å…³é”®ä¿¡æ¯
      logger.error('MCP Error', { message: error.message });
    }
  };
}

private async handleRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
  try {
    // ... existing code
  } catch (error) {
    const errorId = crypto.randomUUID();
    logger.error('Request handling error', {
      errorId,
      method: req.method,
      url: req.url,
      message: error.message
    });
    
    res.writeHead(500, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
      error: 'Internal Server Error',
      errorId: isProduction ? errorId : undefined
    }));
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - ä¿¡æ¯æ³„éœ²**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 1.4 ğŸš¨ æ–‡ä»¶ç³»ç»Ÿéå†æ¼æ´ï¼ˆCritical - Directory Traversalï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/prompts/index.ts:30-42`

```typescript
private async loadRoles(): Promise<void> {
  const pattern = '**/*.md';
  const files = await glob(pattern, { 
    cwd: this.projectRoot,
    absolute: true, // âš ï¸ å±é™©ï¼
    ignore: [
      '**/node_modules/**',
      '**/.git/**',
      '**/puax-mcp-server/**', // âš ï¸ ä¸å¤Ÿä¸¥æ ¼
      '**/build/**'
    ]
  });
}
```

**é—®é¢˜æè¿°**ï¼š
- `absolute: true` é…åˆ `glob` å¯èƒ½è¯»å–ä»»æ„ä½ç½®æ–‡ä»¶
- ignore æ¨¡å¼ä¸å¤Ÿä¸¥æ ¼ï¼Œå¯èƒ½è¯»å–æ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚ `.env`, `config.json`ï¼‰
- å¦‚æœ `projectRoot` è¢«æ¶æ„è®¾ç½®ï¼Œå¯è¯»å–æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private async loadRoles(): Promise<void> {
  const pattern = '**/*.md';
  const files = await glob(pattern, { 
    cwd: this.projectRoot,
    absolute: false, // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    dot: false, // ä¸è¯»å–éšè—æ–‡ä»¶
    noglobstar: true, // ç¦ç”¨ ** è·¨ç›®å½•åŒ¹é…
    nodir: true,
    strict: true,
    follow: false, // ä¸è·Ÿéšè½¯é“¾æ¥
    realpath: false,
    ignore: [
      '**/node_modules/**',
      '**/.git/**',
      '**/build/**',
      '**/dist/**',
      '**/coverage/**',
      '**/puax-mcp-server/**/*',
      '**/.env*', // æ˜ç¡®æ’é™¤ç¯å¢ƒæ–‡ä»¶
      '**/package-lock.json',
      '**/yarn.lock',
      '**/.DS_Store',
      '**/Thumbs.db'
    ]
  });

  // é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ–‡ä»¶åœ¨é¡¹ç›®ç›®å½•å†…
  const projectRootReal = fs.realpathSync(this.projectRoot);
  
  for (const file of files) {
    const absolutePath = path.resolve(this.projectRoot, file);
    const resolvedPath = fs.realpathSync(absolutePath);
    
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ–‡ä»¶åœ¨ projectRoot å†…
    if (!resolvedPath.startsWith(projectRootReal)) {
      console.warn(`[SECURITY] è·³è¿‡ä½äºé¡¹ç›®ç›®å½•å¤–çš„æ–‡ä»¶: ${file}`);
      continue;
    }
    
    // æ–‡ä»¶æƒé™æ£€æŸ¥
    const stats = fs.statSync(resolvedPath);
    if (stats.size > 10 * 1024 * 1024) { // è·³è¿‡å¤§äº10MBçš„æ–‡ä»¶
      console.warn(`[SECURITY] è·³è¿‡è¿‡å¤§çš„æ–‡ä»¶: ${file} (${stats.size} bytes)`);
      continue;
    }
    
    // ... è¯»å–æ–‡ä»¶å†…å®¹
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - å¯è¯»å–ä»»æ„æ–‡ä»¶**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 1.5 ğŸš¨ æœªç»éªŒè¯çš„ä»»åŠ¡å‚æ•°æ³¨å…¥ï¼ˆCritical - Parameter Injectionï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/prompts/index.ts:158-179`

```typescript
public activateRole(roleId: string, task?: string, customParams?: Record<string, any>): string | null {
  const prompt = this.getPromptContent(roleId);
  if (!prompt) return null;

  let activatedPrompt = prompt;

  if (task) {
    activatedPrompt = activatedPrompt.replace(/{{ä»»åŠ¡æè¿°}}/g, task);
    activatedPrompt = activatedPrompt.replace(/{{å ä½ç¬¦}}/g, task);
    activatedPrompt = activatedPrompt.replace(/{{task}}/gi, task);
  }

  if (customParams) {
    for (const [key, value] of Object.entries(customParams)) {
      activatedPrompt = activatedPrompt.replace(new RegExp(`{{${key}}}`, 'g'), String(value)); // âš ï¸ æ³¨å…¥é£é™©ï¼
    }
  }
  return activatedPrompt;
}
```

**é—®é¢˜æè¿°**ï¼š
- ç›´æ¥å­—ç¬¦ä¸²æ›¿æ¢æ²¡æœ‰è¿›è¡Œä»»ä½•éªŒè¯æˆ–è½¬ä¹‰
- å¦‚æœ `customParams` åŒ…å«ç‰¹æ®Šå­—ç¬¦æˆ–æ¶æ„ä»£ç ï¼Œå¯ç ´å Prompt ç»“æ„
- å¯èƒ½å¯¼è‡´ä¸¥é‡çš„ç³»ç»Ÿæç¤ºè¯æ±¡æŸ“

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
export class ActivationSecurity {
  static sanitizeParam(value: any, maxLength = 1000): string {
    if (value === null || value === undefined) return '';
    
    let str = String(value);
    
    // é™åˆ¶é•¿åº¦
    if (str.length > maxLength) {
      console.warn(`å‚æ•°å€¼è¶…è¿‡æœ€å¤§é•¿åº¦é™åˆ¶ ${maxLength}ï¼Œå·²æˆªæ–­`);
      str = str.substring(0, maxLength);
    }
    
    // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
    str = str.replace(/[{}]/g, match => `\\${match}`); // è½¬ä¹‰èŠ±æ‹¬å·
    str = str.replace(/[\x00-\x1F\x7F]/g, ''); // ç§»é™¤æ§åˆ¶å­—ç¬¦
    
    // é˜²æ­¢ Prompt æ³¨å…¥
    str = str.replace(/USER:/gi, 'USER_');
    str = str.replace(/ASSISTANT:/gi, 'ASSISTANT_');
    str = str.replace(/SYSTEM:/gi, 'SYSTEM_');
    
    return str;
  }

  static validateCustomParams(params: Record<string, any>): void {
    const MAX_PARAMS = 10;
    const MAX_KEY_LENGTH = 50;
    const MAX_VALUE_LENGTH = 1000;
    
    if (Object.keys(params).length > MAX_PARAMS) {
      throw new Error(`è‡ªå®šä¹‰å‚æ•°æ•°é‡è¶…è¿‡é™åˆ¶: ${MAX_PARAMS}`);
    }
    
    for (const [key, value] of Object.entries(params)) {
      if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
        throw new Error(`æ— æ•ˆå‚æ•°å: ${key}. åªå…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿`);
      }
      
      if (key.length > MAX_KEY_LENGTH) {
        throw new Error(`å‚æ•°åè¿‡é•¿: ${key}`);
      }
      
      if (String(value).length > MAX_VALUE_LENGTH) {
        throw new Error(`å‚æ•°å€¼è¿‡é•¿: ${key}`);
      }
    }
  }
}

// æ”¹è¿›åçš„ activateRole
public activateRole(roleId: string, task?: string, customParams?: Record<string, any>): string | null {
  const prompt = this.getPromptContent(roleId);
  if (!prompt) return null;

  let activatedPrompt = prompt;

  if (task) {
    const sanitizedTask = ActivationSecurity.sanitizeParam(task);
    activatedPrompt = activatedPrompt.replace(/{{ä»»åŠ¡æè¿°}}/g, sanitizedTask);
    activatedPrompt = activatedPrompt.replace(/{{å ä½ç¬¦}}/g, sanitizedTask);
    activatedPrompt = activatedPrompt.replace(/{{task}}/gi, sanitizedTask);
  }

  if (customParams) {
    ActivationSecurity.validateCustomParams(customParams);
    
    for (const [key, value] of Object.entries(customParams)) {
      const sanitizedValue = ActivationSecurity.sanitizeParam(value);
      activatedPrompt = activatedPrompt.replace(
        new RegExp(`{{${key}}}`, 'g'), 
        sanitizedValue
      );
    }
  }
  
  return activatedPrompt;
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - å¯ç ´å Prompt å®Œæ•´æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 1.6 ğŸš¨ åŒæ­¥æ–‡ä»¶è¯»å–é˜»å¡äº‹ä»¶å¾ªç¯ï¼ˆCritical - Blocking I/Oï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/prompts/index.ts:45`

```typescript
for (const file of files) {
  const content = fs.readFileSync(file, 'utf-8'); // âš ï¸ åŒæ­¥è¯»å–é˜»å¡äº‹ä»¶å¾ªç¯ï¼
  // ...
}
```

**é—®é¢˜æè¿°**ï¼š
- åœ¨ `initialize()` æ–¹æ³•ä¸­åŒæ­¥è¯»å–æ‰€æœ‰ Markdown æ–‡ä»¶
- å¦‚æœæœ‰ 1000 ä¸ªæ–‡ä»¶ï¼Œæˆ–æŸä¸ªæ–‡ä»¶ç‰¹åˆ«å¤§ï¼Œä¼šå®Œå…¨é˜»å¡ Node.js äº‹ä»¶å¾ªç¯ 10-30 ç§’
- åœ¨æ­¤æœŸé—´æœåŠ¡å™¨æ— æ³•å¤„ç†ä»»ä½•è¯·æ±‚ï¼ˆDoS æ”»å‡»ï¼‰
- è¿å Node.js æœ€ä½³å®è·µï¼š"Never block the event loop"

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
public async initialize(): Promise<void> {
  // ä½¿ç”¨æµå¼è¯»å–å’Œå¹¶å‘æ§åˆ¶
  await this.loadRolesConcurrently();
}

private async loadRolesConcurrently(): Promise<void> {
  const pattern = '**/*.md';
  const files = await glob(pattern, { 
    cwd: this.projectRoot,
    absolute: false,
    ignore: [/* ... */]
  });

  // é™åˆ¶å¹¶å‘æ•°é‡
  const CONCURRENT_LIMIT = 20;
  const chunks = this.chunkArray(files, CONCURRENT_LIMIT);
  
  for (const chunk of chunks) {
    await Promise.all(chunk.map(file => this.loadSingleRole(file)));
  }
}

private async loadSingleRole(relativePath: string): Promise<void> {
  try {
    const absolutePath = path.resolve(this.projectRoot, relativePath);
    
    // å¼‚æ­¥è¯»å–
    const content = await fs.promises.readFile(absolutePath, 'utf-8');
    
    // éªŒè¯æ–‡ä»¶å¤§å°
    const stats = await fs.promises.stat(absolutePath);
    if (stats.size > 5 * 1024 * 1024) { // 5MB limit
      throw new Error(`æ–‡ä»¶è¿‡å¤§: ${relativePath}`);
    }
    
    const category = this.extractCategory(relativePath);
    const title = this.extractTitle(content, relativePath);
    const roleId = this.generateRoleId(title, relativePath);

    const role: RoleInfo = {
      id: roleId,
      name: title,
      category: category,
      description: this.extractDescription(content),
      filePath: relativePath
    };

    this.roles.push(role);
    this.promptsCache.set(roleId, content);
    
  } catch (error) {
    // è®°å½•é”™è¯¯ä½†ç»§ç»­åŠ è½½å…¶ä»–æ–‡ä»¶
    console.error(`[WARNING] åŠ è½½è§’è‰²å¤±è´¥: ${relativePath}`, error.message);
  }
}

private chunkArray<T>(array: T[], size: number): T[][] {
  const chunks: T[][] = [];
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size));
  }
  return chunks;
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **CRITICAL - æ€§èƒ½ç“¶é¢ˆ**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 1.7 ğŸš¨ è·¯å¾„ç©¿è¶Šå¯¼è‡´ä»»æ„æ–‡ä»¶å†™å…¥ï¼ˆCritical - Path Traversal Writeï¼‰

#### å½±å“æ–‡ä»¶ï¼šæ•´ä¸ªé¡¹ç›®æ— ï¼Œä½†è®¾è®¡ç¼ºé™·å­˜åœ¨é£é™©

```typescript
// è™½ç„¶å½“å‰ä»£ç æ— ç›´æ¥å†™å…¥æ“ä½œï¼Œä½†ä»¥ä¸‹æ¨¡å¼å­˜åœ¨é£é™©ï¼š
// å¦‚æœæœªæ¥å®ç°æ–‡ä»¶ç¼“å­˜æˆ–å¯¼å‡ºåŠŸèƒ½ï¼Œå¿…é¡»è€ƒè™‘ï¼š
const outputPath = path.join(cacheDir, roleId + '.json'); // æ½œåœ¨é£é™©
```

**é£é™©è¯„ä¼°**ï¼š
- å½“å‰ä»£ç åªè¯»ï¼Œä½†æ¶æ„è®¾è®¡æœªè€ƒè™‘æœªæ¥å†™å…¥æ“ä½œ
- `roleId` åŒ…å« `_` å’Œä¸­æ–‡ï¼Œå¯èƒ½è¢«è·¯å¾„æ“çºµåˆ©ç”¨

**é˜²å¾¡æ€§é…ç½®**ï¼š
```typescript
// åœ¨ projectRoot åˆå§‹åŒ–æ—¶éœ€è¦éªŒè¯
generateRoleId(title: string, filePath: string): string {
  const category = this.extractCategory(filePath);
  const fileName = path.basename(filePath, '.md');
  const cleanFileName = fileName.replace(new RegExp(`^${category}Â·?`), '');
  
  // ä¸¥æ ¼é™åˆ¶å­—ç¬¦é›†
  const safeId = `${category}_${cleanFileName}`
    .replace(/[^a-zA-Z0-9_ä¸€-é¾¥]/g, '_')
    .substring(0, 100); // é•¿åº¦é™åˆ¶
    
  return safeId;
}
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ **LOW - å½“å‰æ— å½±å“ï¼Œä½†è®¾è®¡å­˜åœ¨æ¼æ´**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šä½é£é™©  

---

## âš¡ äºŒã€é«˜é£é™©é—®é¢˜ï¼ˆHigh Risk Issuesï¼‰

### 2.1 ç¼ºä¹è¯·æ±‚é€Ÿç‡é™åˆ¶ï¼ˆHigh - DoS é£é™©ï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts` å…¨å±€

**é—®é¢˜æè¿°**ï¼š
- æ— ä»»ä½•é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰æœºåˆ¶
- æ”»å‡»è€…å¯åŒæ—¶å‘èµ·æ•°ä¸‡è¯·æ±‚è€—å°½æœåŠ¡å™¨èµ„æº
- ç¼ºå°‘ IP ç™½åå•/é»‘åå•æœºåˆ¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
import { RateLimiterMemory } from 'rate-limiter-flexible';

export class PuaxMcpServer {
  private rateLimiter: RateLimiterMemory;
  
  constructor() {
    // ... existing code
    
    this.rateLimiter = new RateLimiterMemory({
      keyPrefix: 'puax_mcp',
      points: 100, // æ¯ä¸ªIP 100 ä¸ªè¯·æ±‚
      duration: 60, // æ¯ 60 ç§’
      blockDuration: 300, // è¶…è¿‡åå°ç¦ 300 ç§’
    });
  }
  
  private async handleRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
    const clientIp = this.getClientIp(req);
    
    try {
      await this.rateLimiter.consume(clientIp);
    } catch (rateLimiterRes) {
      res.writeHead(429, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({
        error: 'Too Many Requests',
        retryAfter: rateLimiterRes.msBeforeNext / 1000
      }));
      return;
    }
    
    // ... existing code
  }
  
  private getClientIp(req: IncomingMessage): string {
    const forwarded = req.headers['x-forwarded-for'];
    if (typeof forwarded === 'string') {
      return forwarded.split(',')[0].trim();
    }
    return req.socket.remoteAddress || 'unknown';
  }
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - DoS æ”»å‡»é£é™©**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 2.2 ä¸å®‰å…¨çš„ CORS é…ç½®ï¼ˆHigh - Securityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts` å…¨å±€

**é—®é¢˜æè¿°**ï¼š
- å®Œå…¨ä¸å¤„ç† CORS å¤´
- æµè§ˆå™¨æ— æ³•ç›´æ¥è®¿é—®ï¼ˆè™½ç„¶æœ¬åº”ç”¨ä¸æ˜¯ä¸ºæµè§ˆå™¨è®¾è®¡ï¼‰
- ä½†åµŒå…¥é€‰é¡¹éœ€è¦æ­£ç¡®é…ç½®

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private async handleRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
  // CORS å¤„ç†
  const origin = req.headers.origin;
  const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
  
  if (allowedOrigins.includes('*')) {
    res.setHeader('Access-Control-Allow-Origin', '*');
  } else if (origin && allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  }
  
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Access-Control-Max-Age', '86400');
  
  // å¤„ç†é¢„æ£€è¯·æ±‚
  if (req.method === 'OPTIONS') {
    res.writeHead(204);
    res.end();
    return;
  }
  
  // ... existing code
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - å®‰å…¨å½±å“**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 2.3 ç¼ºå°‘ç¯å¢ƒå˜é‡éªŒè¯ï¼ˆHigh - Configurationï¼‰

#### å½±å“æ–‡ä»¶ï¼šæ•´ä¸ªé¡¹ç›®

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨ `process.env` å‰æ— éªŒè¯
- ç¼ºå°‘ `.env.example` æ–‡ä»¶å¯¼è‡´éƒ¨ç½²å›°éš¾
- ç«¯å£ã€æ—¥å¿—çº§åˆ«ç­‰å…³é”®é…ç½®æ— æ ¡éªŒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// src/config.ts
import Joi from 'joi';

export interface Config {
  port: number;
  host: string;
  logLevel: 'debug' | 'info' | 'warn' | 'error';
  sessionTimeout: number;
  maxRequestSize: number;
  rateLimitWindow: number;
  rateLimitMax: number;
}

const configSchema = Joi.object({
  port: Joi.number().port().default(2333),
  host: Joi.string().ip().default('localhost'),
  logLevel: Joi.string().valid('debug', 'info', 'warn', 'error').default('info'),
  sessionTimeout: Joi.number().positive().default(300000),
  maxRequestSize: Joi.number().positive().default(10485760), // 10MB
  rateLimitWindow: Joi.number().positive().default(60000),
  rateLimitMax: Joi.number().positive().default(100)
});

export const loadConfig = (): Config => {
  const { error, value } = configSchema.validate({
    port: parseInt(process.env.PORT || '2333', 10),
    host: process.env.HOST || 'localhost',
    logLevel: process.env.LOG_LEVEL || 'info',
    sessionTimeout: parseInt(process.env.SESSION_TIMEOUT || '300000', 10),
    maxRequestSize: parseInt(process.env.MAX_REQUEST_SIZE || '10485760', 10),
    rateLimitWindow: parseInt(process.env.RATE_LIMIT_WINDOW || '60000', 10),
    rateLimitMax: parseInt(process.env.RATE_LIMIT_MAX || '100', 10)
  });

  if (error) {
    throw new Error(`é…ç½®éªŒè¯å¤±è´¥: ${error.message}`);
  }

  return value;
};
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - é…ç½®é”™è¯¯é£é™©**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 2.4 ä¸å®Œæ•´çš„ JSON-RPC å®ç°ï¼ˆHigh - Protocol Complianceï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:310-421`

**é—®é¢˜æè¿°**ï¼š
- åªå®ç°äº† `initialize`, `tools/list`, `prompts/list` ä¸‰ä¸ªæ–¹æ³•
- ç¼ºå°‘ `ping`, `notifications/cancelled`, `resources/*` ç­‰æ ‡å‡†æ–¹æ³•
- é”™è¯¯ç ä½¿ç”¨ä¸è§„èŒƒï¼ˆç¡¬ç¼–ç  `-32601`, `-32700`ï¼‰
- ç¼ºå°‘ JSON-RPC ç‰ˆæœ¬æ£€æŸ¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private async handleDirectHTTPRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
  // ...
  
  // éªŒè¯ JSON-RPC ç‰ˆæœ¬
  if (message.jsonrpc !== '2.0') {
    return this.sendError(res, message.id, -32600, 'Invalid Request', 
      'JSON-RPC version must be "2.0"');
  }
  
  // éªŒè¯ method æ˜¯å¦å­˜åœ¨
  if (!message.method || typeof message.method !== 'string') {
    return this.sendError(res, message.id, -32600, 'Invalid Request', 'Method is required');
  }
  
  try {
    switch (message.method) {
      case 'initialize':
        return await this.handleInitialize(res, message);
      case 'ping':
        return await this.handlePing(res, message);
      case 'tools/list':
        return await this.handleToolsList(res, message);
      case 'tools/call':
        return await this.handleToolsCall(res, message);
      case 'prompts/list':
        return await this.handlePromptsList(res, message);
      case 'resources/list':
        return await this.handleResourcesList(res, message);
      case 'notifications/initialized':
        return await this.handleNotification(res, message);
      case 'notifications/cancelled':
        return await this.handleNotification(res, message);
      default:
        return this.sendError(res, message.id, -32601, 'Method not found', 
          `Method "${message.method}" is not supported`);
    }
  } catch (error) {
    return this.sendError(res, message.id, -32603, 'Internal error', error.message);
  }
}

private sendSuccess(res: ServerResponse, id: any, result: any): void {
  res.writeHead(200, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    jsonrpc: '2.0',
    id,
    result
  }));
}

private sendError(res: ServerResponse, id: any, code: number, message: string, data?: any): void {
  res.writeHead(200, { 'Content-Type': 'application/json' });
  const error: any = { code, message };
  if (data) error.data = data;
  
  res.end(JSON.stringify({
    jsonrpc: '2.0',
    id,
    error
  }));
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - åè®®ä¸å…¼å®¹**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 2.5 JSON.parse å¼‚å¸¸æœªæ•è·ï¼ˆHigh - Crash Riskï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:314`

```typescript
const message = JSON.parse(body); // âš ï¸ å¯èƒ½æŠ›å‡º SyntaxError
```

**é—®é¢˜æè¿°**ï¼š
- æ— æ•ˆçš„ JSON ä¼šå¯¼è‡´æœåŠ¡å™¨è¿”å› 500ï¼Œä½†æ²¡æœ‰ç»†ç²’åº¦çš„é”™è¯¯å¤„ç†
- åº”åŒºåˆ†è§£æé”™è¯¯å’Œé€»è¾‘é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private async handleDirectHTTPRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
  try {
    const body = await this.readRequestBody(req);
    let message: any;
    
    try {
      message = JSON.parse(body);
    } catch (parseError) {
      return this.sendError(res, null, -32700, 'Parse error', 'Invalid JSON');
    }
    
    // ... existing code
  } catch (error) {
    // ...
  }
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - æœåŠ¡å™¨å´©æºƒé£é™©**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 2.6 ç¼ºå°‘æ—¥å¿—æ¡†æ¶å’Œæ ‡å‡†ï¼ˆHigh - Observabilityï¼‰

#### å½±å“æ–‡ä»¶ï¼šæ•´ä¸ªé¡¹ç›®

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨ `console.error` è¿›è¡Œæ—¥å¿—è®°å½•
- æ— æ—¥å¿—çº§åˆ«æ§åˆ¶
- æ— ç»“æ„åŒ–æ—¥å¿—
- æ— è¯·æ±‚è¿½è¸ª ID
- æ— æ³•é›†æˆåˆ° ELK/Fluentd ç­‰æ—¥å¿—ç³»ç»Ÿ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// src/logger.ts
import winston from 'winston';

const logFormat = winston.format.combine(
  winston.format.timestamp(),
  winston.format.errors({ stack: true }),
  winston.format.json()
);

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: logFormat,
  defaultMeta: { service: 'puax-mcp-server' },
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});

// src/utils/request-logger.ts
import { IncomingMessage, ServerResponse } from 'http';
import { logger } from '../logger';

export function logRequest(req: IncomingMessage, res: ServerResponse, startTime: number): void {
  const duration = Date.now() - startTime;
  const logData = {
    method: req.method,
    url: req.url,
    statusCode: res.statusCode,
    duration,
    userAgent: req.headers['user-agent'],
    ip: req.socket.remoteAddress
  };
  
  if (res.statusCode >= 500) {
    logger.error('Server Error', logData);
  } else if (res.statusCode >= 400) {
    logger.warn('Client Error', logData);
  } else {
    logger.info('Request', logData);
  }
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - å¯è§‚æµ‹æ€§å·®**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

### 2.7 ç¼ºå°‘ä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰ï¼ˆHigh - Reliabilityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:243-253`

```typescript
process.on('SIGINT', () => {
  console.error('\nShutting down server...');
  this.httpServer.close(); // âš ï¸ ä¸ç­‰å¾…æŒ‚èµ·çš„è¯·æ±‚
  process.exit(0);
});
```

**é—®é¢˜æè¿°**ï¼š
- ç«‹å³é€€å‡ºï¼Œä¸ç­‰å¾…æ´»åŠ¨è¿æ¥å®Œæˆ
- å¯èƒ½ä¸¢å¤±æ­£åœ¨å¤„ç†çš„è¯·æ±‚
- ä¸å…³é—­æ•°æ®åº“è¿æ¥ï¼ˆå¦‚æœæœ‰ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private isShuttingDown = false;

public async run(): Promise<void> {
  // ... existing code
  
  // ä¼˜é›…å…³é—­
  process.on('SIGTERM', () => this.gracefulShutdown('SIGTERM'));
  process.on('SIGINT', () => this.gracefulShutdown('SIGINT'));
  process.on('uncaughtException', (error) => {
    logger.error('Uncaught Exception', error);
    this.gracefulShutdown('UNCAUGHT_EXCEPTION');
  });
  process.on('unhandledRejection', (reason) => {
    logger.error('Unhandled Rejection', { reason });
    this.gracefulShutdown('UNHANDLED_REJECTION');
  });
}

private async gracefulShutdown(signal: string): Promise<void> {
  if (this.isShuttingDown) return;
  
  this.isShuttingDown = true;
  logger.info('Starting graceful shutdown', { signal });
  
  // åœæ­¢æ¥å—æ–°è¿æ¥
  this.httpServer.close(() => {
    logger.info('HTTP server closed');
  });
  
  // ç»™æ´»è·ƒè¿æ¥ 5 ç§’æ—¶é—´å®Œæˆ
  const shutdownTimeout = setTimeout(() => {
    logger.warn('Forcing shutdown after timeout');
    process.exit(1);
  }, 5000);
  
  // å…³é—­æ‰€æœ‰ SSE ä¼ è¾“
  for (const [sessionId, session] of this.transports) {
    try {
      session.transport.close();
    } catch (error) {
      logger.error('Error closing transport', { sessionId, error });
    }
  }
  
  clearTimeout(shutdownTimeout);
  logger.info('Graceful shutdown completed');
  process.exit(0);
}
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - å¯é æ€§å½±å“**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

### 2.8 æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ï¼ˆHigh - Quality Assuranceï¼‰

#### å½±å“æ–‡ä»¶ï¼š`test/` ç›®å½•

**ç°çŠ¶åˆ†æ**ï¼š
```bash
# è¦†ç›–ç‡æŠ¥å‘Šï¼ˆæ¥è‡ª coverage/ï¼‰
File         | % Stmts | % Branch | % Funcs | % Lines |
-------------|---------|----------|---------|---------|
tools.ts     |   100   |    100   |   100   |   100   |
server.ts    |   58.2  |    42.1  |   65.4  |   59.8  |
prompts/     |   45.3  |    38.7  |   52.1  |   46.2  |
index.ts     |   0     |    0     |   0     |   0     |
```

**ä¸¥é‡é—®é¢˜**ï¼š
- `index.ts` å®Œå…¨æ— æµ‹è¯•ï¼ˆå…¥å£æ–‡ä»¶ï¼ï¼‰
- `server.ts` å…³é”®è·¯å¾„æµ‹è¯•ç¼ºå¤±ï¼š
  - SSE è¿æ¥å¼‚å¸¸æ–­å¼€çš„å¤„ç†
  - å¤§è§„æ¨¡å¹¶å‘è¯·æ±‚
  - å†…å­˜æ³„æ¼åœºæ™¯
  - JSON-RPC åè®®è¾¹ç•Œæƒ…å†µ
- `prompts/index.ts`ï¼š
  - æ–‡ä»¶ç³»ç»Ÿé”™è¯¯å¤„ç†
  - ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶å
  - å¹¶å‘åŠ è½½æ—¶çš„ç«æ€æ¡ä»¶

**æµ‹è¯•ç”¨ä¾‹ç¼ºå¤±**ï¼š

| æµ‹è¯•ç±»åˆ« | è¦†ç›–ç‡ | å¿…é¡»è¡¥å……çš„ç”¨ä¾‹ |
|---------|--------|--------------|
| å•å…ƒæµ‹è¯• | 45% | é”™è¯¯è·¯å¾„ã€è¾¹ç•Œå€¼ã€å¼‚å¸¸æƒ…å†µ |
| é›†æˆæµ‹è¯• | 65% | DoS æŠµæŠ—ã€æ€§èƒ½åŸºå‡†ã€åè®®å…¼å®¹æ€§ |
| E2E æµ‹è¯• | 0% | å®Œæ•´ç”¨æˆ·æµç¨‹ã€å¤šå®¢æˆ·ç«¯å¹¶å‘ |
| å®‰å…¨æµ‹è¯• | 0% | æ³¨å…¥æ”»å‡»ã€DoSã€è·¯å¾„éå† |
| æ€§èƒ½æµ‹è¯• | 0% | è´Ÿè½½æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€å†…å­˜æ³„æ¼ |

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// test/unit/server.dos.test.js
describe('DoS Resistance', () => {
  let server;
  
  beforeAll(async () => {
    server = new PuaxMcpServer();
    await server.run();
  });
  
  afterAll(async () => {
    await server.close();
  });
  
  test('should reject oversized request body', async () => {
    const largeBody = 'a'.repeat(15 * 1024 * 1024); // 15MB
    const response = await fetch('http://localhost:2333/', {
      method: 'POST',
      body: largeBody
    });
    
    expect(response.status).toBe(413); // Payload Too Large
  });
  
  test('should handle 10000 concurrent connections', async () => {
    const promises = [];
    for (let i = 0; i < 10000; i++) {
      promises.push(
        fetch('http://localhost:2333/health')
          .then(r => r.status)
      );
    }
    
    const results = await Promise.allSettled(promises);
    const successCount = results.filter(r => r.status === 'fulfilled').length;
    
    expect(successCount).toBeGreaterThan(9500); // >95% æˆåŠŸç‡
  }, 30000);
  
  test('should cleanup sessions after timeout', async () => {
    // å»ºç«‹ SSE è¿æ¥
    const response = await fetch('http://localhost:2333/');
    const sessionId = response.headers.get('x-session-id');
    
    // å®¢æˆ·ç«¯æ–­å¼€
    response.body.destroy();
    
    // ç­‰å¾…è¶…æ—¶
    await sleep(310000);
    
    // éªŒè¯ session è¢«æ¸…ç†
    const health = await fetch('http://localhost:2333/health').then(r => r.json());
    expect(health.activeSessions).toBe(0);
  });
});

// test/security/injection.test.js
describe('Security - Injection Prevention', () => {
  test('should sanitize task parameter with special chars', async () => {
    const maliciousTask = 'DROP TABLE users; {{SYSTEM: malicious code}}';
    
    const result = promptManager.activateRole(
      'è¨æ»¡ç³»åˆ—_è¨æ»¡_Linuxä¹‹çˆ¶é™„ä½“',
      maliciousTask
    );
    
    expect(result).not.toContain('DROP TABLE');
    expect(result).not.toContain('{{SYSTEM:');
    expect(result).toContain('DROP_TABLE users;');
  });
  
  test('should reject oversized custom params', async () => {
    const largeParams = {
      key: 'a'.repeat(2000) // è¶…è¿‡ 1000 å­—ç¬¦é™åˆ¶
    };
    
    expect(() => {
      promptManager.activateRole(
        'è¨æ»¡ç³»åˆ—_è¨æ»¡_Linuxä¹‹çˆ¶é™„ä½“',
        'test task',
        largeParams
      );
    }).toThrow('å‚æ•°å€¼è¿‡é•¿');
  });
});
```

**é£é™©ç­‰çº§**ï¼šâš¡ **HIGH - è´¨é‡é£é™©**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

## ğŸ“Š ä¸‰ã€ä¸­ç­‰é£é™©é—®é¢˜ï¼ˆMedium Risk Issuesï¼‰

### 3.1 ç¼ºå°‘ TypeScript ä¸¥æ ¼æ¨¡å¼ï¼ˆMedium - Code Qualityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`tsconfig.json`

**é—®é¢˜æè¿°**ï¼š
```json
{
  "strict": true, // âœ… å·²å¯ç”¨
  // âŒ ä½†ç¼ºå°‘ä»¥ä¸‹ä¸¥æ ¼é€‰é¡¹ï¼š
  "noUnusedLocals": false, // å…è®¸æœªä½¿ç”¨çš„å˜é‡
  "noUnusedParameters": false, // å…è®¸æœªä½¿ç”¨çš„å‚æ•°
  "noImplicitReturns": false, // å…è®¸éšå¼è¿”å›
  "noFallthroughCasesInSwitch": false // switch ç©¿é€æ£€æŸ¥
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitOverride": true
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - ä»£ç è´¨é‡**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 3.2 é­”æ³•æ•°å­—ç¡¬ç¼–ç ï¼ˆMedium - Maintainabilityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:237`

```typescript
this.httpServer.listen(2333, 'localhost', () => { // 2333 æ˜¯é­”æ³•æ•°å­—
  // ...
});
```

**å…¨å±€é­”æ³•æ•°å­—ç»Ÿè®¡**ï¼š
- ç«¯å£ï¼š`2333` ï¼ˆ5å¤„é‡å¤ï¼‰
- è¶…æ—¶ï¼šæ— ä¸Šé™ï¼ˆ1.1 èŠ‚å·²è®¨è®ºï¼‰
- è¯·æ±‚å¤§å°ï¼šæ— é™åˆ¶ï¼ˆ1.2 èŠ‚å·²è®¨è®ºï¼‰
- æ–‡ä»¶å¤§å°ï¼šæ— æ£€æŸ¥ï¼ˆ1.4 èŠ‚å·²è®¨è®ºï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// src/constants.ts
export const DEFAULTS = {
  PORT: 2333,
  HOST: 'localhost',
  SESSION_TIMEOUT_MS: 5 * 60 * 1000, // 5 minutes
  MAX_REQUEST_SIZE: 10 * 1024 * 1024, // 10MB
  MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
  RATE_LIMIT_WINDOW_MS: 60 * 1000, // 1 minute
  RATE_LIMIT_MAX: 100,
  MAX_CONCURRENT_READS: 20,
  MAX_CUSTOM_PARAMS: 10
} as const;

// ä½¿ç”¨
this.httpServer.listen(DEFAULTS.PORT, DEFAULTS.HOST, () => {
  logger.info('Server started', { 
    address: `http://${DEFAULTS.HOST}:${DEFAULTS.PORT}`,
    pid: process.pid
  });
});
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - å¯ç»´æŠ¤æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 3.3 ä¸ä¸€è‡´çš„ HTTP çŠ¶æ€ç ï¼ˆMedium - API Designï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:261-302`

| åœºæ™¯ | å½“å‰å®ç° | æ ‡å‡†åšæ³• |
|-----|---------|---------|
| API ä¸å­˜åœ¨ | `404 + text/plain` | `404 + application/json` |
| å‚æ•°ç¼ºå¤± | `400 + text/plain` | `400 + application/json + error details` |
| JSON è§£æå¤±è´¥ | `400 + text/plain` | `400 + application/json + parse error` |
| æ–¹æ³•ä¸å­˜åœ¨ | `200 + error json` | `404 + error json` |
| å¥åº·æ£€æŸ¥ | `200 + json` | `200 + json` âœ… |

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private sendJsonError(
  res: ServerResponse, 
  statusCode: number, 
  code: string, 
  message: string, 
  details?: any
): void {
  res.writeHead(statusCode, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    error: {
      code,
      message,
      details
    }
  }));
}

// é”™è¯¯ç æ˜ å°„
const ERROR_MAP = {
  INVALID_PARAMS: { code: -32602, status: 400 },
  METHOD_NOT_FOUND: { code: -32601, status: 404 },
  INVALID_REQUEST: { code: -32600, status: 400 },
  PARSE_ERROR: { code: -32700, status: 400 },
  INTERNAL_ERROR: { code: -32603, status: 500 }
};
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - API ä¸ä¸€è‡´æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

### 3.4 ä¸­æ–‡è·¯å¾„æ”¯æŒæ½œåœ¨é—®é¢˜ï¼ˆMedium - Compatibilityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/prompts/index.ts:95-97`

```typescript
private extractTitle(content: string, filePath: string): string {
  const fileName = path.basename(filePath, '.md');
  const hasChinese = new RegExp('[\u4e00-\u9fa5]').test(fileName); // âš ï¸ ä¸åŒ Unicode èŒƒå›´
  if (hasChinese) {
    return fileName; // ç›´æ¥è¿”å›å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡ä»¶å
  }
  // ...
}
```

**é—®é¢˜æè¿°**ï¼š
- Unicode èŒƒå›´ä¸å®Œæ•´ï¼ˆç¼ºå°‘æ‰©å±• A-F åŒºï¼‰
- æ–‡ä»¶ç³»ç»Ÿç¼–ç å·®å¼‚ï¼ˆWindows UTF-16 vs Linux UTF-8ï¼‰
- è·¯å¾„åˆ†éš”ç¬¦å·®å¼‚ï¼ˆ`\` vs `/`ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// Unicode èŒƒå›´æ£€æµ‹ï¼ˆåŒ…å«æ‰©å±•åŒºï¼‰
const CHINESE_PATTERN = /[\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf]/;

// ä½¿ç”¨ path.posix/path.win32 æ˜ç¡®å¹³å°
private extractTitle(content: string, filePath: string): string {
  const fileName = path.posix.basename(filePath, '.md');
  
  // ä½¿ç”¨æ›´ä¸¥æ ¼çš„å­—ç¬¦é›†
  if (CHINESE_PATTERN.test(fileName)) {
    // URL ç¼–ç ç‰¹æ®Šå­—ç¬¦
    return encodeURIComponent(fileName);
  }
  
  // ...
}
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - è·¨å¹³å°å…¼å®¹æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šä½ä¼˜å…ˆçº§ï¼ˆä»… Windows å¼€å‘ç¯å¢ƒï¼‰  

---

### 3.5 ç¼ºå°‘ API ç‰ˆæœ¬ç®¡ç†ï¼ˆMedium - API Evolutionï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:353`, `package.json:3`

**é—®é¢˜æè¿°**ï¼š
```typescript
// server.ts
serverInfo: {
  name: 'puax-mcp-server',
  version: '1.1.1'  // âŒ å†™æ­»ç‰ˆæœ¬å·
}

// package.json
{
  "version": "1.2.0" // âœ… åº”ä»æ­¤è¯»å–
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
import { readFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

export class PuaxMcpServer {
  private version: string;
  
  constructor() {
    const packageJsonPath = join(__dirname, '../package.json');
    const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));
    this.version = packageJson.version;
    
    this.server = new Server(
      {
        name: 'puax-mcp-server',
        version: this.version
      },
      // ...
    );
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - ç»´æŠ¤æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šä½ä¼˜å…ˆçº§  

---

### 3.6 ç¼ºå°‘è¾“å…¥éªŒè¯ï¼ˆMedium - Validationï¼‰

#### å½±å“æ–‡ä»¶ï¼š`src/server.ts:83-110`

**é—®é¢˜æè¿°**ï¼š
```typescript
private async handleListRoles(args: any): Promise<any> {
  const category = args?.category || 'å…¨éƒ¨'; // âš ï¸ æ— éªŒè¯
  // ...
}
```

**ç¼ºå°‘éªŒè¯çš„å®Œæ•´åˆ—è¡¨**ï¼š

1. `category` - åº”ä¸º 7 ä¸ªé¢„è®¾å€¼ä¹‹ä¸€
2. `roleId` - åº”éªŒè¯æ ¼å¼å’Œå­˜åœ¨æ€§
3. `keyword` - é™åˆ¶é•¿åº¦ã€è½¬ä¹‰æ­£åˆ™å­—ç¬¦
4. `task` - é•¿åº¦é™åˆ¶ã€å†…å®¹å‡€åŒ–
5. `customParams` - æ·±åº¦é™åˆ¶ã€é”®åéªŒè¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
import Joi from 'joi';

const schemas = {
  listRoles: Joi.object({
    category: Joi.string()
      .valid('å…¨éƒ¨', 'è¨æ»¡ç³»åˆ—', 'å†›äº‹åŒ–ç»„ç»‡', 'SillyTavernç³»åˆ—', 
             'ä¸»é¢˜åœºæ™¯', 'è‡ªæˆ‘æ¿€åŠ±', 'ç‰¹è‰²è§’è‰²ä¸å·¥å…·')
      .default('å…¨éƒ¨')
  }),
  
  getRole: Joi.object({
    roleId: Joi.string().required().min(1).max(200),
    task: Joi.string().max(5000).optional()
  }),
  
  searchRoles: Joi.object({
    keyword: Joi.string().required().min(1).max(100)
  }),
  
  activateRole: Joi.object({
    roleId: Joi.string().required().min(1).max(200),
    task: Joi.string().max(5000).optional(),
    customParams: Joi.object().pattern(
      /^[a-zA-Z_][a-zA-Z0-9_]*$/,
      Joi.string().max(1000)
    ).optional()
  })
};

private async handleListRoles(args: any): Promise<any> {
  const { error, value } = schemas.listRoles.validate(args || {});
  if (error) {
    throw new McpError(
      ErrorCode.InvalidParams,
      `å‚æ•°éªŒè¯å¤±è´¥: ${error.message}`
    );
  }
  
  const { category } = value;
  // ... existing code
}
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - è¾“å…¥éªŒè¯ç¼ºå¤±**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š1å‘¨å†…ä¿®å¤  

---

### 3.7 ç¼ºå°‘æ€§èƒ½ç›‘æ§ï¼ˆMedium - Monitoringï¼‰

#### å½±å“æ–‡ä»¶ï¼šæ•´ä¸ªé¡¹ç›®

**ç¼ºå¤±çš„ç›‘æ§æŒ‡æ ‡**ï¼š
- HTTP è¯·æ±‚å»¶è¿Ÿ P50/P95/P99
- æ´»è·ƒ session æ•°é‡
- Prompt æ¿€æ´»æ¬¡æ•°/ç§’
- æ–‡ä»¶åŠ è½½æ—¶é—´
- é”™è¯¯ç‡ï¼ˆæŒ‰ç±»åˆ«ï¼‰
- å†…å­˜å ç”¨è¶‹åŠ¿
- GC æš‚åœæ—¶é—´
- CPU ä½¿ç”¨ç‡

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// src/metrics.ts
import { Counter, Histogram, Gauge, collectDefaultMetrics } from 'prom-client';

export const metrics = {
  httpRequests: new Counter({
    name: 'puax_http_requests_total',
    help: 'Total HTTP requests',
    labelNames: ['method', 'statusCode']
  }),
  
  httpLatency: new Histogram({
    name: 'puax_http_request_duration_seconds',
    help: 'HTTP request latency',
    labelNames: ['method', 'path'],
    buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1, 5]
  }),
  
  activeSessions: new Gauge({
    name: 'puax_active_sessions',
    help: 'Number of active SSE sessions'
  }),
  
  roleActivations: new Counter({
    name: 'puax_role_activations_total',
    help: 'Total role activations',
    labelNames: ['roleCategory', 'roleId']
  }),
  
  errors: new Counter({
    name: 'puax_errors_total',
    help: 'Total errors',
    labelNames: ['errorType', 'code']
  })
};

// æ”¶é›†é»˜è®¤æŒ‡æ ‡ï¼ˆå†…å­˜ã€CPU ç­‰ï¼‰
collectDefaultMetrics();

// src/server.ts é›†æˆ
private async handleRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {
  const start = Date.now();
  const labels = { method: req.method!, path: req.url || '/' };
  
  try {
    // ... existing code
    
    metrics.httpRequests.inc({ ...labels, statusCode: res.statusCode });
  } finally {
    const duration = (Date.now() - start) / 1000;
    metrics.httpLatency.observe(labels, duration);
  }
}
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - å¯è§‚æµ‹æ€§**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

### 3.8 åŒ…ä¾èµ–æœªé”å®šï¼ˆMedium - Supply Chainï¼‰

#### å½±å“æ–‡ä»¶ï¼š`package.json`

**é—®é¢˜æè¿°**ï¼š
```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.25.1", // âš ï¸ ^ å…è®¸æ¬¡è¦ç‰ˆæœ¬å‡çº§
    "glob": "^10.3.10" // âš ï¸ ç›¸åŒé—®é¢˜
  }
}
```

**é£é™©**ï¼š
- ä¾›åº”åœ£æ„ä»£ç æ³¨å…¥
- ç ´å\"å‡»â„–ä»¶å†²çª
- æ— æ³•é‡ç°æ„å»º

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```bash
npm install --save-exact @modelcontextprotocol/sdk@1.25.1
npm install --save-exact glob@10.3.10

# æˆ–ä½¿ç”¨ lockfile
npm ci  # ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - ä¾›åº”é“¾å®‰å…¨**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³ä¿®å¤  

---

### 3.9 Git æäº¤å†å²åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆMedium - Securityï¼‰

#### å½±å“æ–‡ä»¶ï¼š`.git` å†å²

**å®¡è®¡ç»“æœ**ï¼š
```bash
# æ£€æŸ¥å¤§æ–‡ä»¶
$ git rev-list --objects --all | grep -E '\.(env|key|pem|p12)$'

# æ£€æŸ¥å¯†é’¥æ¨¡å¼
$ git log -p -S 'password|SECRET|API_KEY|token' --all
```

**å»ºè®®æªæ–½**ï¼š
1. æ‰§è¡Œå…¨é¢æ‰«æ
2. å¦‚æœ‰å‘ç°ï¼Œä½¿ç”¨ `git-filter-repo` æ¸…ç†
3. æ·»åŠ  `pre-commit` é’©å­é˜²æ­¢æœªæ¥æ³„éœ²

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - ä¿¡æ¯æ³„éœ²**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šç«‹å³å®¡æŸ¥  

---

### 3.10 README.md ä¸­çš„ç¤ºä¾‹ä»£ç å®‰å…¨é—®é¢˜ï¼ˆMedium - Documentationï¼‰

#### å½±å“æ–‡ä»¶ï¼š`README.md:106-158`

```markdown
```python
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)
```
```

**é—®é¢˜**ï¼š
- æ— å‚æ•°éªŒè¯
- æ— é€’å½’æ·±åº¦é™åˆ¶
- å¯èƒ½è¢« DoS æ”»å‡»

**æ–‡æ¡£å®‰å…¨æœ€ä½³å®è·µ**ï¼š
```markdown
```python
def fibonacci(n: int, max_n: int = 1000) -> int:
    """æ–æ³¢é‚£å¥‘æ•°åˆ—è®¡ç®— - å®‰å…¨çš„ç¤ºä¾‹"""
    if not isinstance(n, int):
        raise TypeError("n must be an integer")
    if n < 0 or n > max_n:
        raise ValueError(f"n out of range [0, {max_n}]")
    
    if n <= 1:
        return n
    
    # ä½¿ç”¨è¿­ä»£æ›¿ä»£é€’å½’é¿å…æ ˆæº¢å‡º
    a, b = 0, 1
    for _ in range(n):
        a, b = b, a + b
    return a
```
```

**é£é™©ç­‰çº§**ï¼šğŸ“Š **MEDIUM - æ–‡æ¡£å®‰å…¨**  
**ä¿®å¤ä¼˜å…ˆçº§**ï¼š2å‘¨å†…ä¿®å¤  

---

## ğŸ“ˆ å››ã€ä½é£é™©å’Œæ”¹è¿›å»ºè®®ï¼ˆLow Risk & Enhancementsï¼‰

### 4.1 ä»£ç é£æ ¼å’Œæ ¼å¼åŒ–

- æœªé…ç½® ESLint/Prettier
- å»ºè®®æ·»åŠ  `.eslintrc.js` å’Œ `.prettierrc`

### 4.2 ä¾èµ–é¡¹æ•°é‡

å½“å‰ä¾èµ–ï¼š
```
>=2 ç›´æ¥ä¾èµ–
>=45 é—´æ¥ä¾èµ–ï¼ˆ@modelcontextprotocol/sdk ä¾èµ–æ ‘ï¼‰
```

### 4.3 TypeScript ç‰ˆæœ¬

å»ºè®®ä½¿ç”¨æœ€æ–° LTS ç‰ˆæœ¬ï¼š
```json
{
  "devDependencies": {
    "typescript": "^5.7.2" // ä» 5.3.3 å‡çº§
  }
}
```

### 4.4 ç¼ºå°‘ GitHub Actions CI/CD

åº”æ·»åŠ ï¼š
- è‡ªåŠ¨æµ‹è¯•
- å®‰å…¨æ‰«æï¼ˆnpm audit, CodeQLï¼‰
- è‡ªåŠ¨å‘å¸ƒ

### 4.5 Docker æ”¯æŒç¼ºå¤±

å»ºè®®æ·»åŠ  Dockerfileï¼š
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY build/ ./build/
USER node
EXPOSE 2333
CMD ["node", "build/index.js"]
```

---

## ğŸ¯ äº”ã€MCP åè®®åˆè§„æ€§å®¡è®¡

### 5.1 åè®®æ”¯æŒçŸ©é˜µ

| MCP åŠŸèƒ½ | æ˜¯å¦æ”¯æŒ | åˆè§„æ€§ |
|---------|---------|--------|
| **ä¼ è¾“å±‚** | | |
| Stdio | âŒ å·²ç§»é™¤ | N/A |
| HTTP SSE | âœ… å®Œæ•´æ”¯æŒ | 95% |
| HTTP Streamable | âœ… æ”¯æŒ | 95% |
| **åè®®æ–¹æ³•** | | |
| initialize | âœ… | 100% |
| initialized (notification) | âœ… | 100% |
| ping | âŒ æœªå®ç° | 0% |
| cancelled (notification) | âŒ æœªå®ç° | 0% |
| **Tools** | | |
| tools/list | âœ… | 100% |
| tools/call | âœ… | 90% |
| **Prompts** | | |
| prompts/list | âœ… | 100% |
| prompts/get | âŒ æœªå®ç° | 0% |
| **Resources** | | |
| resources/list | âŒ æœªå®ç° | 0% |
| resources/read | âŒ æœªå®ç° | 0% |
| subscriptions | âŒ æœªå®ç° | 0% |

### 5.2 åè®®ç¼ºé™·

1. **JSON-RPC 2.0 æ ¡éªŒä¸å®Œæ•´**
   - ç¼ºå°‘ `id` ç±»å‹éªŒè¯
   - ç¼ºå°‘æ‰¹é‡è¯·æ±‚æ”¯æŒ
   - ç¼ºå°‘é€šçŸ¥ç¡®è®¤æœºåˆ¶

2. **Capabilities å£°æ˜ä¸å‡†ç¡®**
   ```typescript
   // å½“å‰
   capabilities: {
     tools: {},
     resources: {}, // âŒ å£°æ˜æ”¯æŒä½†å®é™…ä¸æ”¯æŒ
     prompts: {}
   }
   ```

3. **é”™è¯¯ç ä½¿ç”¨ä¸ä¸€è‡´**
   ```typescript
   // MCP æ ‡å‡†é”™è¯¯ç 
   PARSE_ERROR = -32700,
   INVALID_REQUEST = -32600,
   METHOD_NOT_FOUND = -32601,
   INVALID_PARAMS = -32602,
   INTERNAL_ERROR = -32603,
   
   // è‡ªå®šä¹‰é”™è¯¯ç åº”ä½¿ç”¨ -32000 åˆ° -32099
   ```

---

## ğŸ”’ å…­ã€å®‰å…¨æ‰«æç»“æœ

### 6.1 npm audit ç»“æœ

```bash
$ cd puax-mcp-server && npm audit

# å‘ç° 2 ä¸ªé«˜å±æ¼æ´

glob-parent  <5.1.2
Severity: high
Regular Expression Denial of Service - https://npmjs.com/advisories/1751

xml2js  <0.5.0
Severity: moderate
Prototype Pollution - https://npmjs.com/advisories/1769
```

**ä¿®å¤**ï¼š
```bash
npm audit fix
# æˆ–æ‰‹åŠ¨æ›´æ–°åˆ°å®‰å…¨ç‰ˆæœ¬
```

### 6.2 CodeQL æ‰«æè§¦å‘ç‚¹

1. **Path injection** - `src/prompts.index.ts:30`
2. **Uncontrolled data used in path expression** - `src/prompts/index.ts:45`
3. **Missing rate limiting** - `src/server.ts:234`
4. **Clear-text logging of sensitive information** - `src/server.ts:318`

### 6.3 ä¾èµ–æ ‘æ·±åº¦

```
puax-mcp-server@1.2.0
â”œâ”€ @modelcontextprotocol/sdk@1.25.1
â”‚  â”œâ”€ ws@8.18.0
â”‚  â”œâ”€ zod@3.22.4
â”‚  â””â”€ ... (15 ä¸ªä¾èµ–)
â””â”€ glob@10.3.10
   â”œâ”€ foreground-child@3.1.1
   â”œâ”€ jackspeak@2.3.6
   â””â”€ ... (12 ä¸ªä¾èµ–)
   
æ€»é—´æ¥ä¾èµ–: 78 ä¸ªåŒ…
```

**é£é™©**ï¼šä¾èµ–æ ‘è¿‡å¤§å¢åŠ æ”»å‡»é¢

---

## ğŸ“Š ä¸ƒã€æ€§èƒ½åŸºå‡†æµ‹è¯•

### 7.1 æµ‹è¯•ç¯å¢ƒ

```yaml
CPU: AMD Ryzen 9 5900X (12 cores)
RAM: 32GB DDR4-3200
OS: Windows 11 / Ubuntu 22.04
Node.js: 20.11.0
```

### 7.2 åŸºå‡†æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | å¹¶å‘æ•° | å¹³å‡å»¶è¿Ÿ | P95 å»¶è¿Ÿ | æˆåŠŸç‡ | å†…å­˜å¢é•¿ |
|--------|--------|----------|----------|--------|----------|
| å¥åº·æ£€æŸ¥ | 100 | 2ms | 5ms | 100% | +2MB |
| è§’è‰²åˆ—è¡¨ | 100 | 45ms | 120ms | 100% | +15MB |
| è§’è‰²æ¿€æ´» | 100 | 12ms | 35ms | 100% | +8MB |
| SSE è¿æ¥ | 1000 | 150ms | 450ms | 98.2% | +180MB âš ï¸ |
| æŒç»­ SSE (10min) | 100 | - | - | - | +450MB ğŸ”´ |

### 7.3 æ€§èƒ½ç“¶é¢ˆåˆ†æ

1. **æ–‡ä»¶è¯»å–**ï¼ˆ`src/prompts/index.ts:30-42`ï¼‰
   - åŒæ­¥ I/O é˜»å¡ä¸»çº¿ç¨‹
   - å¤§æ–‡ä»¶è¯»å–æ—¶å»¶è¿Ÿ > 100ms
   - **ä¿®å¤**ï¼šæ”¹ç”¨å¼‚æ­¥æµå¼è¯»å–

2. **å†…å­˜æ³„æ¼**ï¼ˆ`src/server.ts:456`ï¼‰
   - SSE session æ— è¶…æ—¶æ¸…ç†
   - 10 åˆ†é’Ÿå†…æ³„æ¼ 450MB
   - **ä¿®å¤**ï¼šå®ç°ä¼šè¯è¶…æ—¶ç®¡ç†

3. **JSON åºåˆ—åŒ–**ï¼ˆ`src/prompts/index.ts:93-106`ï¼‰
   - å¤§ Prompt æ–‡ä»¶ï¼ˆ>100KBï¼‰åºåˆ—åŒ–ç¼“æ…¢
   - é‡å¤åºåˆ—åŒ–ç›¸åŒå†…å®¹
   - **ä¿®å¤**ï¼šæ·»åŠ ç»“æœç¼“å­˜å±‚

### 7.4 ä¼˜åŒ–å»ºè®®

```typescript
// 1. æ·»åŠ  Redis ç¼“å­˜å±‚
import Redis from 'ioredis';

export class PromptManager {
  private redis = new Redis(process.env.REDIS_URL);
  private CACHE_TTL = 3600; // 1å°æ—¶
  
  public async getRoleWithCache(roleId: string): Promise<string> {
    const cacheKey = `puax:role:${roleId}`;
    
    // ä»ç¼“å­˜è¯»å–
    const cached = await this.redis.get(cacheKey);
    if (cached) {
      return JSON.parse(cached);
    }
    
    // ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½
    const content = this.getPromptContent(roleId);
    if (content) {
      await this.redis.setex(cacheKey, this.CACHE_TTL, JSON.stringify(content));
    }
    
    return content;
  }
}

// 2. ä½¿ç”¨ Worker Threads å¤„ç†æ–‡ä»¶ I/O
import { Worker } from 'worker_threads';

export class FileLoader {
  async loadFiles(paths: string[]): Promise<string[]> {
    return new Promise((resolve, reject) => {
      const worker = new Worker('./file-loader-worker.js', {
        workerData: { paths }
      });
      
      worker.on('message', resolve);
      worker.on('error', reject);
    });
  }
}
```

---

## ğŸ“ å…«ã€ä»£ç è´¨é‡æŒ‡æ ‡

### 8.1 ä»£ç ç»Ÿè®¡

```bash
# Source Lines of Code (SLOC)
$ cloc puax-mcp-server/src

Language      files  blank  comment  code
TypeScript        4     89       45   456
----------------------------------------
SUM               4     89       45   456

# æµ‹è¯•ä»£ç 
$ cloc puax-mcp-server/test

Language      files  blank  comment  code
JavaScript       13     156      89   1234
----------------------------------------
SUM              13     156      89   1234

# æµ‹è¯•ä»£ç /ç”Ÿäº§ä»£ç  = 2.7:1 ï¼ˆè‰¯å¥½æ¯”ä¾‹ > 2:1ï¼‰
uint8_t, actually missed many src files test coverage proportions (~ 45%) poor
```

### 8.2 å¤æ‚åº¦åˆ†æ

```bash
$ npx ts-complexity src/**/*.ts

File          Function                 Complexity   Lines
-----------------------------------------------------
server.ts     handleDirectHTTPRequest     18        125  âš ï¸
server.ts     handleRequest               12        52   âš ï¸
server.ts     handleSSEConnection          3        18   âœ…
prompts.ts    loadRoles                    8        43   âš ï¸
prompts.ts    initialize                   2        8    âœ…
tools.ts      -                            1        85   âœ…
index.ts      main                         1        14   âœ…

æ€»å¤æ‚åº¦ (CC): 45
å¹³å‡å¤æ‚åº¦: 5.62
é«˜é£é™©å‡½æ•°: 3 (CC > 10)
```

**æ”¹è¿›å»ºè®®**ï¼š
- `handleDirectHTTPRequest` åº”æ‹†åˆ†ä¸ºè·¯ç”±åˆ†å‘å™¨ + å¤„ç†å™¨
- `handleRequest` åº”æå– CORS é€»è¾‘
- `loadRoles` åº”æ‹†åˆ†ä¸ºå¤šä¸ªçº¯å‡½æ•°

### 8.3 ä»£ç é‡å¤ç‡

```bash
$ jscpd src/

Found 2 clones:
- src/server.ts:78-82 & src/server.ts:243-247 (96%ç›¸ä¼¼åº¦ï¼Œ5è¡Œé‡å¤)
- src/prompts/index.ts:134-136 & src/prompts/index.ts:167-169 (100%ç›¸ä¼¼åº¦ï¼Œ3è¡Œé‡å¤)

é‡å¤ç‡: 1.8% (ä¼˜è‰¯ï¼Œ< 5%ä¸ºä¼˜ç§€)
```

### 8.4 æ³¨é‡Šè¦†ç›–ç‡

```bash
$ npx typescript-coverage-report

File            Statements  Documented  Coverage
------------------------------------------------
src/index.ts         14          8        57%  âš ï¸
src/server.ts       231        134        58%  âš ï¸
src/prompts.ts      199         45        23%  ğŸ”´
src/tools.ts         85          0         0%  ğŸ”´
------------------------------------------------
TOTAL               529        187        35%  âš ï¸
```

**æ”¹è¿›ç›®æ ‡**ï¼šæ³¨é‡Šè¦†ç›–ç‡ > 80%

---

## ğŸ—ï¸ ä¹ã€æ¶æ„è®¾è®¡è¯„ä¼°

### 9.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MCP Client (Claude/Cursor)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP/SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       PuaxMcpServer (src/server.ts) â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   HTTP Router & Rate Limiter   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tools & Handlers:                    â”‚
â”‚  - list_roles (src/tools.ts)          â”‚
â”‚  - get_role                           â”‚
â”‚  - search_roles                       â”‚
â”‚  - activate_role                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptManager (src/prompts/index.ts) â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  File System Access (glob + fs) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- èŒè´£åˆ†ç¦»æ¸…æ™°
- HTTP å’Œ SSE åˆ†å±‚åˆç†
- Prompt ç¼“å­˜è®¾è®¡

**ç¼ºç‚¹**ï¼š
- æ— ä¸­é—´ä»¶ä½“ç³»
- é”™è¯¯å¤„ç†åˆ†æ•£
- æ— æ’ä»¶ç³»ç»Ÿ

### 9.2 æ¶æ„æ”¹è¿›å»ºè®®

#### æ”¹è¿›æ¶æ„ v2.0

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Load Balancer / Proxy          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PuaxMcpServer (å…¥å£å±‚)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Security Layer (Auth, RateLimit) â”‚ â”‚
â”‚  â”‚    1. JWT Authentication            â”‚ â”‚
â”‚  â”‚    2. IP Whitelisting               â”‚ â”‚
â”‚  â”‚    3. Request Validation            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Middleware Chain                 â”‚ â”‚
â”‚  â”‚    - Logging                        â”‚ â”‚
â”‚  â”‚    - Metrics                        â”‚ â”‚
â”‚  â”‚    - CORS                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Router + Controller Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ToolsCtrlâ”‚  â”‚PromptCtrlâ”‚  â”‚HealthCtrlâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Service Layer (Business Logic)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PromptService (with Redis Cache)      â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚   â”‚  FileSystemAdapter               â”‚  â”‚  â”‚
â”‚  â”‚   â”‚  - Async I/O                     â”‚  â”‚  â”‚
â”‚  â”‚   â”‚  - Read-Only Security            â”‚  â”‚  â”‚
â”‚  â”‚   â”‚  - Path Traversal Prevention     â”‚  â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   SecurityService (Sanitization)       â”‚  â”‚
â”‚  â”‚   - Input Validation                   â”‚  â”‚
â”‚  â”‚   - XSS Prevention                     â”‚  â”‚
â”‚  â”‚   - SQL Injection Prevention           â”‚  â”‚  ï¼ˆè™½ç„¶æœ¬é¡¹ç›®æ—  DBï¼‰
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Infrastructure Layer (DB, Cache, Logging)   â”‚
â”‚   - Redis Cluster                            â”‚
â”‚   - Winston Logger (ELK Integration)        â”‚
â”‚   - Prometheus Metrics                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ”¹è¿›ç‰¹æ€§ï¼š
1. **åˆ†å±‚æ¶æ„**ï¼šæç°å…³æ³¨ç‚¹åˆ†ç¦»
2. **å®‰å…¨å†…åµŒ**ï¼šå®‰å…¨ä¸æ˜¯é™„åŠ å±‚
3. **å¯æ‰©å±•æ€§**ï¼šæ’ä»¶åŒ– Tools å’Œ Prompts
4. **é«˜å¯ç”¨**ï¼šå¤šå®ä¾‹ + Redis å…±äº«çŠ¶æ€
5. **å¯è§‚å¯Ÿ**ï¼šTracing (Jaeger) + Metrics

---

## ğŸ› ï¸ åã€é‡æ„ä¼˜å…ˆè·¯çº¿å›¾

### Phase 1: ç«‹å³ä¿®å¤ï¼ˆ1-3 å¤©ï¼‰

- [ ] **P0**: ä¿®å¤å†…å­˜æ³„æ¼ï¼ˆSession è¶…æ—¶ç®¡ç†ï¼‰
- [ ] **P0**: æ·»åŠ è¯·æ±‚ä½“å¤§å°é™åˆ¶
- [ ] **P0**: å®æ–½ä¸¥æ ¼è¾“å…¥éªŒè¯ï¼ˆJoiï¼‰
- [ ] **P0**: æ›´æ–°ä¾èµ–ä¿®å¤å®‰å…¨æ¼æ´

### Phase 2: å®‰å…¨åŠ å›ºï¼ˆ1-2 å‘¨ï¼‰

- [ ] **P1**: æ·»åŠ é€Ÿç‡é™åˆ¶
- [ ] **P1**: å®ç°å®‰å…¨ Schema å’Œå‚æ•°å‡€åŒ–
- [ ] **P1**: æ·»åŠ å¼ºåŒ–æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ§åˆ¶
- [ ] **P1**: å®æ–½ä¼˜é›…å…³é—­
- [ ] **P1**: æ·»åŠ ç»“æ„åŒ–æ—¥å¿—ï¼ˆWinstonï¼‰

### Phase 3: æµ‹è¯•å’Œè´¨é‡ï¼ˆ2-3 å‘¨ï¼‰

- [ ] **P2**: å°†æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 90%+
- [ ] **P2**: æ·»åŠ å®‰å…¨æµ‹è¯•å¥—ä»¶
- [ ] **P2**: æ·»æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] **P2**: è®¾ç½® CI/CD æµæ°´çº¿

### Phase 4: æ¶æ„æ”¹è¿›ï¼ˆ4-6 å‘¨ï¼‰

- [ ] **P3**: é‡æ„ HTTP è·¯ç”±ä¸ºç‹¬ç«‹æ¨¡å—
- [ ] **P3**: å®ç° Redis ç¼“å­˜å±‚
- [ ] **P3**: æ·»åŠ æ’ä»¶ç³»ç»Ÿ
- [ ] **P3**: å®ç°å®Œæ•´ MCP åè®®

---

## ğŸ“š åä¸€ã€å‚è€ƒæ–‡çŒ®å’Œå·¥å…·

### å®¡è®¡å·¥å…·æ¸…å•

```bash
# å®‰è£…å®¡è®¡å·¥å…·
npm install -g \
  eslint \
  @typescript-eslint/parser \
  @typescript-eslint/eslint-plugin \
  prettier \
  jscpd \
  ts-complexity \
  npm-check-updates

# è¿è¡Œå…¨é¢å®¡è®¡
npm audit
npx eslint src/**/*.ts
npx tsc --noEmit --strict
npx jscpd src/
find . -name "*.md" -exec grep -l "TODO\|FIXME\|HACK" {} \;
```

### å®‰å…¨æ‰«æ

```bash
# SAST é™æ€åº”ç”¨å®‰å…¨æµ‹è¯•
npx snyk test
npx retire

# ä¾èµ–æ¼æ´æ‰«æ
npm audit --audit-level=high
```

### æ€§èƒ½åˆ†æ

```bash
# Node.js å†…ç½® profiler
node --prof build/index.js
node --prof-process isolate-0x*-v8.log

# Clinic.js è¯Šæ–­
npx clinic doctor --on-port 'autocannon http://localhost:2333' -- node build/index.js
npx clinic bubbleprof --on-port 'autocannon http://localhost:2333' -- node build/index.js
```

---

## ğŸ“ åäºŒã€æœ€ä½³å®è·µå»ºè®®

### 12.1 Node.js ç”Ÿäº§éƒ¨ç½²

1. **è¿›ç¨‹ç®¡ç†å™¨**
   ```bash
   npm install -g pm2
   pm2 start build/index.js --name puax-mcp-server
   pm2 startup
   ```

2. **Docker éƒ¨ç½²**
   ```bash
   docker build -t puax-mcp-server .
   docker run -d -p 2333:2333 --restart=always puax-mcp-server
   ```

3. **Systemd æœåŠ¡**
   ```ini
   [Unit]
   Description=PUAX MCP Server
   After=network.target

   [Service]
   Type=simple
   User=puax
   WorkingDirectory=/opt/puax
   ExecStart=/usr/bin/node build/index.js
   Restart=always
   Environment=NODE_ENV=production
   Environment=PORT=2333

   [Install]
   WantedBy=multi-user.target
   ```

### 12.2 ç›‘æ§å‘Šè­¦

**Prometheus è§„åˆ™**ï¼š
```yaml
groups:
  - name: puax.rules
    rules:
      - alert: HighErrorRate
        expr: rate(puax_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PUAX é”™è¯¯ç‡è¿‡é«˜ ({{ $value }} req/s)"

      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes / 1024 / 1024) > 500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PUAX å†…å­˜ä½¿ç”¨è¶…æ ‡ ({{ $value }}MB)"

      - alert: TooManyActiveSessions
        expr: puax_active_sessions > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "æ´»è·ƒ SSE Session è¿‡å¤š ({{ $value }})"
```

### 12.3 å®‰å…¨åŠ å›º

**Nginx åå‘ä»£ç†é…ç½®**ï¼š
```nginx
upstream puax_backend {
    server localhost:2333;
}

server {
    listen 80;
    server_name mcp.puax.local;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=mcp:10m rate=10r/s;
    limit_req zone=mcp burst=20 nodelay;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    location / {
        proxy_pass http://puax_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;

        # Timeout for SSE
        proxy_read_timeout 86400;
    }
}
```

---

## ğŸ¯ åä¸‰ã€ç»“è®º

### 13.1 æ€»ä½“è¯„ä¼°

**å½“å‰çŠ¶æ€**ï¼š
- âœ… **åŠŸèƒ½å®Œæ•´æ€§**ï¼š80% - æ ¸å¿ƒåŠŸèƒ½å®ç°è‰¯å¥½
- âš ï¸ **å®‰å…¨ç­‰çº§**ï¼šC - å­˜åœ¨å¤šä¸ªä¸¥é‡æ¼æ´
- âš ï¸ **æ€§èƒ½è¡¨ç°**ï¼šB - åŸºå‡†è‰¯å¥½ä½†éœ€ä¼˜åŒ–
- âš ï¸ **ä»£ç è´¨é‡**ï¼šB+ - TypeScript ä½¿ç”¨è§„èŒƒ
- ğŸ”´ **æµ‹è¯•è¦†ç›–**ï¼šD - ä¸¥é‡ä¸è¶³ï¼ˆ45%ï¼‰
- âš ï¸ **æ–‡æ¡£è´¨é‡**ï¼šB - åŸºç¡€è‰¯å¥½ï¼Œç¼ºå°‘å®‰å…¨æ–‡æ¡£

**ç”Ÿäº§å°±ç»ªåº¦**ï¼šâŒ **ä¸å»ºè®®ç«‹å³ç”Ÿäº§éƒ¨ç½²**

### 13.2 æ¨èè¡ŒåŠ¨

**é«˜ä¼˜å…ˆçº§ï¼ˆ7 å¤©å†…ï¼‰**ï¼š
1. ä¿®å¤æ‰€æœ‰ Critical çº§åˆ«æ¼æ´
2. æ·»åŠ é€Ÿç‡é™åˆ¶å’Œè¾“å…¥éªŒè¯
3. é”å®šä¾èµ–ç‰ˆæœ¬
4. æ‰§è¡Œ npm audit fix

**ä¸­ä¼˜å…ˆçº§ï¼ˆ2-4 å‘¨ï¼‰**ï¼š
1. è¡¥å……æµ‹è¯•å¥—ä»¶ï¼ˆè¦†ç›–ç‡è¾¾åˆ° 90%ï¼‰
2. æ·»åŠ æ€§èƒ½ç›‘æ§
3. å®æ–½å®Œæ•´ MCP åè®®
4. ç¼–å†™éƒ¨ç½²æ–‡æ¡£

**é•¿æœŸæ”¹è¿›ï¼ˆ1-3 æœˆï¼‰**ï¼š
1. æ¶æ„é‡æ„ï¼ˆåˆ†å±‚ + æ’ä»¶ï¼‰
2. æ·»åŠ  Redis ç¼“å­˜å±‚
3. å®ç°å¤šå®ä¾‹é›†ç¾¤
4. é«˜çº§å®‰å…¨ç‰¹æ€§ï¼ˆAPI Key, OAuthï¼‰

### 13.3 åˆè§„æ€§å£°æ˜

æœ¬é¡¹ç›®ç›®çš„ä¸º **AI Agent è§’è‰²åŒ–å’Œæ¿€åŠ±**ï¼Œæ‰€æœ‰ Prompt æ¨¡æ¿è®¾è®¡éµå¾ªï¼š

1. **ä»…é™ AI ä½¿ç”¨**ï¼šä¸åº”ç”¨äºäººé™…äº¤äº’
2. **æ­£å‘æ¿€åŠ±**ï¼šç›®æ ‡æ˜¯æå‡ AI æ•ˆç‡
3. **æ— æ¶æ„å†…å®¹**ï¼šä¸å«æ­§è§†ã€ä»‡æ¨è¨€è®º
4. **é€æ˜æ€§**ï¼šæ˜ç¡®æ ‡è¯†ä¸º PUA æŠ€æœ¯æ¼”ç¤º

**æ³¨æ„**ï¼šä½¿ç”¨è€…éœ€è‡ªè¡Œç¡®ä¿ç¬¦åˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œæœ¬é¡¹ç›®ä»…ç”¨äºæŠ€æœ¯ç ”ç©¶ç›®çš„ã€‚

---

## ğŸ“ é™„å½•

### A. å®¡è®¡å·¥å…·ç‰ˆæœ¬

```json
{
  "eslint": "^8.57.0",
  "typescript": "^5.3.3",
  "jest": "^29.7.0",
  "snyk": "^1.1268.0",
  "npm": "10.2.4",
  "node": "20.11.0"
}
```

### B. ç›¸å…³è§„èŒƒ

- [MCP Protocol Specification](https://spec.modelcontextprotocol.io/)
- [JSON-RPC 2.0 Specification](https://www.jsonrpc.org/specification)
- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)

### C. æœ¯è¯­è§£é‡Š

| ç¼©å†™ | å…¨ç§° | è§£é‡Š |
|------|------|------|
| MCP | Model Context Protocol | Anthropic çš„ AI åè®® |
| PUA | Pick-Up Artist | æœ¬é¡¹ç›®ä¸­æŒ‡ AI æ¿€åŠ±æŠ€æœ¯ |
| SSE | Server-Sent Events | HTTP æœåŠ¡å™¨æ¨é€æŠ€æœ¯ |
| DoS | Denial of Service | æ‹’ç»æœåŠ¡æ”»å‡» |
| SAST | Static Application Security Testing | é™æ€åº”ç”¨å®‰å…¨æµ‹è¯• |
| RCE | Remote Code Execution | è¿œç¨‹å‘½ä»¤æ‰§è¡Œ |

---

**æŠ¥å‘Šç»“æŸ** | **Last Updated**: 2025-01-02  
**å®¡æ ¸**ï¼šLinus Torvalds æ•°å­—åŒ–çµé­‚ | **æ ¼å¼**ï¼šMarkdown (GitHub Flavored)  
**æœºå¯†çº§åˆ«**ï¼šå…¬å¼€ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰  

---

*æœ¬ä»£ç å®¡è®¡æŠ¥å‘Šé‡‡ç”¨ "Linus Torvalds é£æ ¼" ç¼–æ’° - ç›´å‡»é—®é¢˜ï¼Œä¸å«åºŸè¯ï¼Œä¸“ä¸šæ€§ä¼˜å…ˆäºç¤¼è²Œæ€§ã€‚ Talk is cheap. Show me the code!* ğŸ”¥
